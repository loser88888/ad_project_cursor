---
description: Ad plan management, including CRUD operations, scheduling, and targeting.
globs: **/ad_plan.js, **/AdPlan.vue
---
# 模块 4: 广告计划管理

## ⚠️ 重要提示

**开发本模块时，请确保：**
1. 前后端接口严格对齐（参考 `ARCHITECTURE.md`）
2. UI 样式对齐参考网站 https://www.smallfighter.cn/cidProduct.html
3. 所有接口返回统一格式：`{ code, message, data }`
4. 支持批量操作功能（批量启用、暂停、删除）

## 一、模块概述

本模块负责广告计划的创建、编辑、状态管理及数据追踪。完成后应具备：
- ✅ 计划创建（支持批量创建）
- ✅ 计划编辑（基本信息、投放策略）
- ✅ 计划状态管理（启用、暂停、删除）
- ✅ 计划复制功能
- ✅ 批量操作功能

## 二、功能需求

### 2.1 广告计划管理
- **计划创建**：支持单个/批量创建、模板创建
- **计划编辑**：基本信息修改、投放策略调整
- **计划状态管理**：启用、暂停、删除
- **计划复制**：快速复制已有计划
- **批量操作**：批量启用、暂停、删除

## 三、数据库设计

### 3.1 广告计划表（ad_plans）

（数据库设计与原文件相同，保持不变）

索引设计：
```javascript
db.ad_plans.createIndex({ userId: 1 });
db.ad_plans.createIndex({ accountId: 1 });
db.ad_plans.createIndex({ status: 1 });
db.ad_plans.createIndex({ platform: 1 });
db.ad_plans.createIndex({ userId: 1, status: 1 });
```

## 四、后端实现

### 4.1 广告计划控制器（app/controller/ad_plan.js）

**注意：**原文件已有完整实现，需要确保：
1. 所有接口返回统一格式：`{ code, message, data }`
2. 错误响应格式统一
3. 添加批量操作接口

**批量操作接口补充：**

```javascript
// 批量更新状态
async batchUpdateStatus() {
  const { ctx } = this;
  const userId = ctx.state.user.id;
  const { ids, status } = ctx.request.body;

  ctx.validate({
    ids: { type: 'array', required: true },
    status: { type: 'string', required: true, enum: ['active', 'paused', 'deleted'] },
  });

  await ctx.model.AdPlan.updateMany(
    { _id: { $in: ids }, userId },
    { status, updatedAt: Date.now() }
  );

  ctx.body = {
    code: 200,
    message: '批量更新状态成功',
    data: { count: ids.length },
  };
}

// 批量删除
async batchDelete() {
  const { ctx } = this;
  const userId = ctx.state.user.id;
  const { ids } = ctx.request.body;

  ctx.validate({
    ids: { type: 'array', required: true },
  });

  await ctx.model.AdPlan.deleteMany({ _id: { $in: ids }, userId });

  ctx.body = {
    code: 200,
    message: '批量删除成功',
    data: { count: ids.length },
  };
}
```

**路由配置补充：**

```javascript
// 广告计划相关路由
router.post('/api/ad-plan', jwt, controller.adPlan.create);
router.get('/api/ad-plan', jwt, controller.adPlan.list);
router.get('/api/ad-plan/:id', jwt, controller.adPlan.detail);
router.put('/api/ad-plan/:id', jwt, controller.adPlan.update);
router.delete('/api/ad-plan/:id', jwt, controller.adPlan.delete);
router.post('/api/ad-plan/batch/status', jwt, controller.adPlan.batchUpdateStatus);
router.post('/api/ad-plan/batch/delete', jwt, controller.adPlan.batchDelete);
```

## 五、前端实现

### 5.1 API 定义（src/api/ad_plan.js）

```javascript
import api from './index';

export const adPlanApi = {
  create: (data) => api.post('/api/ad-plan', data),
  list: (params) => api.get('/api/ad-plan', { params }),
  detail: (id) => api.get(`/api/ad-plan/${id}`),
  update: (id, data) => api.put(`/api/ad-plan/${id}`, data),
  delete: (id) => api.delete(`/api/ad-plan/${id}`),
  batchUpdateStatus: (ids, status) => api.post('/api/ad-plan/batch/status', { ids, status }),
  batchDelete: (ids) => api.post('/api/ad-plan/batch/delete', { ids }),
};
```

### 5.2 广告计划列表页面（src/views/AdPlan.vue）

**关键特性：**
- 支持批量选择
- 批量操作（启用、暂停、删除）
- 筛选功能（平台、状态、账户）
- 表格展示统计数据
- UI样式对齐参考网站

**批量操作示例：**

```vue
<template>
  <div class="ad-plan-container">
    <!-- 批量操作栏 -->
    <div v-if="selectedRows.length > 0" class="batch-actions">
      <el-button type="primary" @click="batchUpdateStatus('active')">
        批量启用 ({{ selectedRows.length }})
      </el-button>
      <el-button type="warning" @click="batchUpdateStatus('paused')">
        批量暂停 ({{ selectedRows.length }})
      </el-button>
      <el-button type="danger" @click="batchDelete">
        批量删除 ({{ selectedRows.length }})
      </el-button>
    </div>

    <!-- 表格 -->
    <el-table
      :data="planList"
      v-loading="loading"
      border
      @selection-change="handleSelectionChange"
    >
      <el-table-column type="selection" width="55" />
      <!-- 其他列... -->
    </el-table>
  </div>
</template>

<script setup>
// 批量操作处理
const batchUpdateStatus = async (status) => {
  const ids = selectedRows.value.map(row => row._id);
  await adPlanApi.batchUpdateStatus(ids, status);
  ElMessage.success('批量操作成功');
  loadPlans();
};

const batchDelete = async () => {
  const ids = selectedRows.value.map(row => row._id);
  await ElMessageBox.confirm('确定要删除选中的计划吗？', '提示', { type: 'warning' });
  await adPlanApi.batchDelete(ids);
  ElMessage.success('批量删除成功');
  loadPlans();
};
</script>
```

## 六、对齐检查清单

### 后端检查项
- [ ] 所有接口返回统一格式：`{ code, message, data }`
- [ ] 批量操作接口实现
- [ ] 错误响应格式统一

### 前端检查项
- [ ] API调用参数名与后端一致
- [ ] 批量操作功能正常
- [ ] UI样式对齐参考网站
- [ ] 表格数据展示正确

### 接口对齐检查
- [ ] 批量更新状态：`POST /api/ad-plan/batch/status` - 前后端参数一致
- [ ] 批量删除：`POST /api/ad-plan/batch/delete` - 前后端参数一致

### UI 样式检查
- [ ] 页面使用蓝色主题
- [ ] 批量操作栏样式符合规范
- [ ] 表格样式对齐参考网站
- [ ] 响应式布局正常

**注意：**完整的前端实现代码与原文件保持一致，只需确保添加批量操作功能和UI样式对齐。
