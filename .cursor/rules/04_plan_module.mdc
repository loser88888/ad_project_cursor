---
description: Ad plan management, including CRUD operations, scheduling, and targeting.
globs: **/ad_plan.js, **/AdPlan.vue
---
# 模块 4: 广告计划管理

本模块负责广告计划的创建、编辑、状态管理及数据追踪。

## 二、功能需求

### 2.2.3 广告计划管理
- 计划创建：支持批量创建、模板创建
- 计划编辑：基本信息修改、投放策略调整
- 计划状态管理：启用、暂停、删除
- 计划复制：快速复制已有计划

## 三、数据库设计

### 3.1.3 广告计划表（ad_plans）

```javascript
{
  _id: ObjectId,
  userId: ObjectId,          // 关联用户ID
  accountId: ObjectId,       // 关联广告账户ID
  planName: String,          // 计划名称
  platform: String,          // 平台
  objective: String,         // 投放目标：转化、曝光、点击
  budget: Number,            // 预算
  schedule: {                // 投放时间设置
    startTime: Date,
    endTime: Date,
    isAllDay: Boolean,
    timeSlots: Array
  },
  targeting: {               // 定向设置
    age: Array,
    gender: String,
    regions: Array,
    interests: Array,
    devices: Array
  },
  status: String,            // 状态：active、paused、deleted
  stats: {                   // 统计数据
    impressions: Number,
    clicks: Number,
    conversions: Number,
    cost: Number,
    ctr: Number,
    cvr: Number,
    roi: Number
  },
  createdAt: Date,           // 创建时间
  updatedAt: Date            // 更新时间
}
```

索引设计：
```javascript
db.ad_plans.createIndex({ userId: 1 });
db.ad_plans.createIndex({ accountId: 1 });
db.ad_plans.createIndex({ status: 1 });
```

## 四、后端实现

### 4.3.3 广告计划模型（app/model/ad_plan.js）

```javascript
module.exports = app => {
  const mongoose = app.mongoose;
  const Schema = mongoose.Schema;

  const AdPlanSchema = new Schema({
    userId: { type: Schema.Types.ObjectId, ref: 'User', required: true },
    accountId: { type: Schema.Types.ObjectId, ref: 'AdAccount', required: true },
    planName: { type: String, required: true },
    platform: { type: String, required: true },
    objective: { type: String, enum: ['conversion', 'impression', 'click'], default: 'conversion' },
    budget: { type: Number, required: true },
    schedule: {
      startTime: { type: Date, required: true },
      endTime: { type: Date, required: true },
      isAllDay: { type: Boolean, default: true },
      timeSlots: { type: Array, default: [] },
    },
    targeting: {
      age: { type: Array, default: [] },
      gender: { type: String, enum: ['all', 'male', 'female'], default: 'all' },
      regions: { type: Array, default: [] },
      interests: { type: Array, default: [] },
      devices: { type: Array, default: [] },
    },
    status: { type: String, enum: ['active', 'paused', 'deleted'], default: 'active' },
    stats: {
      impressions: { type: Number, default: 0 },
      clicks: { type: Number, default: 0 },
      conversions: { type: Number, default: 0 },
      cost: { type: Number, default: 0 },
      ctr: { type: Number, default: 0 },
      cvr: { type: Number, default: 0 },
      roi: { type: Number, default: 0 },
    },
    createdAt: { type: Date, default: Date.now },
    updatedAt: { type: Date, default: Date.now },
  });

  return mongoose.model('AdPlan', AdPlanSchema);
};
```

### 4.4.2 广告计划控制器（app/controller/ad_plan.js）

```javascript
const Controller = require('egg').Controller;

class AdPlanController extends Controller {
  // 创建广告计划
  async create() {
    const { ctx } = this;
    const userId = ctx.state.user.id;
    const {
      accountId,
      planName,
      platform,
      objective,
      budget,
      schedule,
      targeting,
    } = ctx.request.body;

    // 验证参数
    ctx.validate({
      accountId: { type: 'string', required: true },
      planName: { type: 'string', required: true },
      platform: { type: 'string', required: true },
      objective: { type: 'string', required: true },
      budget: { type: 'number', required: true },
      schedule: { type: 'object', required: true },
      targeting: { type: 'object', required: true },
    });

    // 检查广告账户是否存在
    const adAccount = await ctx.model.AdAccount.findOne({
      _id: accountId,
      userId,
    });
    if (!adAccount) {
      ctx.status = 404;
      ctx.body = { message: '广告账户不存在' };
      return;
    }

    // 创建广告计划
    const adPlan = new ctx.model.AdPlan({
      userId,
      accountId,
      planName,
      platform,
      objective,
      budget,
      schedule,
      targeting,
    });
    await adPlan.save();

    ctx.status = 201;
    ctx.body = {
      message: '广告计划创建成功',
      data: adPlan,
    };
  }

  // 获取广告计划列表
  async list() {
    const { ctx } = this;
    const userId = ctx.state.user.id;
    const { page = 1, pageSize = 10, status, platform } = ctx.query;

    // 构建查询条件
    const query = { userId };
    if (status) query.status = status;
    if (platform) query.platform = platform;

    // 分页查询
    const total = await ctx.model.AdPlan.countDocuments(query);
    const adPlans = await ctx.model.AdPlan.find(query)
      .skip((page - 1) * pageSize)
      .limit(Number(pageSize))
      .sort({ createdAt: -1 });

    ctx.body = {
      message: '获取广告计划列表成功',
      data: {
        list: adPlans,
        pagination: {
          total,
          page: Number(page),
          pageSize: Number(pageSize),
          pages: Math.ceil(total / pageSize),
        },
      },
    };
  }

  // 获取广告计划详情
  async detail() {
    const { ctx } = this;
    const userId = ctx.state.user.id;
    const { id } = ctx.params;

    const adPlan = await ctx.model.AdPlan.findOne({
      _id: id,
      userId,
    });
    if (!adPlan) {
      ctx.status = 404;
      ctx.body = { message: '广告计划不存在' };
      return;
    }

    ctx.body = {
      message: '获取广告计划详情成功',
      data: adPlan,
    };
  }

  // 更新广告计划
  async update() {
    const { ctx } = this;
    const userId = ctx.state.user.id;
    const { id } = ctx.params;
    const updateData = ctx.request.body;

    // 验证参数
    ctx.validate({
      planName: { type: 'string', required: false },
      budget: { type: 'number', required: false },
      schedule: { type: 'object', required: false },
      targeting: { type: 'object', required: false },
      status: { type: 'string', required: false },
    });

    // 检查广告计划是否存在
    const adPlan = await ctx.model.AdPlan.findOne({
      _id: id,
      userId,
    });
    if (!adPlan) {
      ctx.status = 404;
      ctx.body = { message: '广告计划不存在' };
      return;
    }

    // 更新广告计划
    const updatedAdPlan = await ctx.model.AdPlan.findByIdAndUpdate(
      id,
      { ...updateData, updatedAt: Date.now() },
      { new: true }
    );

    ctx.body = {
      message: '广告计划更新成功',
      data: updatedAdPlan,
    };
  }

  // 删除广告计划
  async delete() {
    const { ctx } = this;
    const userId = ctx.state.user.id;
    const { id } = ctx.params;

    // 检查广告计划是否存在
    const adPlan = await ctx.model.AdPlan.findOne({
      _id: id,
      userId,
    });
    if (!adPlan) {
      ctx.status = 404;
      ctx.body = { message: '广告计划不存在' };
      return;
    }

    // 删除广告计划
    await ctx.model.AdPlan.findByIdAndDelete(id);

    ctx.body = {
      message: '广告计划删除成功',
    };
  }
}

module.exports = AdPlanController;
```

### 4.5 路由配置补充（app/router.js）

```javascript
  // 广告计划相关路由
  router.post('/api/ad-plan', jwt, controller.adPlan.create);
  router.get('/api/ad-plan', jwt, controller.adPlan.list);
  router.get('/api/ad-plan/:id', jwt, controller.adPlan.detail);
  router.put('/api/ad-plan/:id', jwt, controller.adPlan.update);
  router.delete('/api/ad-plan/:id', jwt, controller.adPlan.delete);
```

## 五、前端实现

### 5.5 API 补充 (src/api/index.js)

```javascript
// 广告计划相关API
export const adPlanApi = {
  create: data => api.post('/api/ad-plan', data),
  list: params => api.get('/api/ad-plan', { params }),
  detail: id => api.get(`/api/ad-plan/${id}`),
  update: (id, data) => api.put(`/api/ad-plan/${id}`, data),
  delete: id => api.delete(`/api/ad-plan/${id}`),
};
```
