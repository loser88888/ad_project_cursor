---
description: Statistics analysis, reporting, and dashboard visualization.
globs: **/statistics.js, **/Dashboard.vue, **/Statistics.vue
---
# 模块 6: 数据统计与优化

本模块负责数据统计分析、报表生成及智能优化建议，包含仪表盘页面的实现。

## 二、功能需求

### 2.2.5 数据统计分析
- 实时数据监控：展示实时投放数据
- 历史数据查询：支持按时间维度查询
- 效果分析：ROI、CTR、CVR 等关键指标分析
- 报表生成：支持导出 Excel、PDF 报表

### 2.2.6 智能优化建议
- 投放策略优化：基于 AI 算法的投放建议
- 创意优化建议：基于用户反馈的创意改进建议
- 预算分配建议：基于效果数据的预算调整建议

## 三、数据库设计

### 3.1.5 数据统计表（statistics）

```javascript
{
  _id: ObjectId,
  userId: ObjectId,          // 关联用户ID
  planId: ObjectId,          // 关联广告计划ID
  creativeId: ObjectId,      // 关联广告创意ID
  date: Date,                // 统计日期
  platform: String,          // 平台
  metrics: {                 // 指标
    impressions: Number,     // 曝光量
    clicks: Number,          // 点击量
    conversions: Number,     // 转化量
    cost: Number,            // 消耗
    ctr: Number,             // 点击率
    cvr: Number,             // 转化率
    roi: Number              // 投资回报率
  },
  createdAt: Date,           // 创建时间
  updatedAt: Date            // 更新时间
}
```

索引设计：
```javascript
db.statistics.createIndex({ userId: 1 });
db.statistics.createIndex({ planId: 1 });
db.statistics.createIndex({ creativeId: 1 });
db.statistics.createIndex({ date: 1 });
db.statistics.createIndex({ platform: 1 });
```

## 四、后端实现

### 4.5 路由配置补充（app/router.js）

```javascript
  // 数据统计相关路由
  router.get('/api/statistics', jwt, controller.statistics.getStatistics);
  router.get('/api/statistics/plan/:id', jwt, controller.statistics.getPlanStatistics);
  router.get('/api/statistics/creative/:id', jwt, controller.statistics.getCreativeStatistics);
```

*(注意：需实现 `app/controller/statistics.js`)*

## 五、前端实现

### 5.5 API 补充 (src/api/index.js)

```javascript
// 数据统计相关API
export const statisticsApi = {
  getStatistics: params => api.get('/api/statistics', { params }),
  getPlanStatistics: (id, params) => api.get(`/api/statistics/plan/${id}`, { params }),
  getCreativeStatistics: (id, params) => api.get(`/api/statistics/creative/${id}`, { params }),
};
```

### 5.6.2 仪表盘页面（src/views/Dashboard.vue）

```vue
<template>
  <div class="dashboard-container">
    <div class="stats-cards">
      <el-card shadow="hover" class="stat-card">
        <div class="stat-content">
          <div class="stat-title">今日消耗</div>
          <div class="stat-value">{{ stats.todayCost.toFixed(2) }} 元</div>
          <div class="stat-change" :class="{ 'increase': stats.costChange > 0, 'decrease': stats.costChange < 0 }">
            <el-icon v-if="stats.costChange > 0"><arrow-up /></el-icon>
            <el-icon v-else-if="stats.costChange < 0"><arrow-down /></el-icon>
            {{ Math.abs(stats.costChange).toFixed(2) }}%
          </div>
        </div>
      </el-card>
      
      <el-card shadow="hover" class="stat-card">
        <div class="stat-content">
          <div class="stat-title">今日转化</div>
          <div class="stat-value">{{ stats.todayConversions }}</div>
          <div class="stat-change" :class="{ 'increase': stats.conversionChange > 0, 'decrease': stats.conversionChange < 0 }">
            <el-icon v-if="stats.conversionChange > 0"><arrow-up /></el-icon>
            <el-icon v-else-if="stats.conversionChange < 0"><arrow-down /></el-icon>
            {{ Math.abs(stats.conversionChange).toFixed(2) }}%
          </div>
        </div>
      </el-card>
      
      <el-card shadow="hover" class="stat-card">
        <div class="stat-content">
          <div class="stat-title">今日ROI</div>
          <div class="stat-value">{{ stats.todayROI.toFixed(2) }}</div>
          <div class="stat-change" :class="{ 'increase': stats.roiChange > 0, 'decrease': stats.roiChange < 0 }">
            <el-icon v-if="stats.roiChange > 0"><arrow-up /></el-icon>
            <el-icon v-else-if="stats.roiChange < 0"><arrow-down /></el-icon>
            {{ Math.abs(stats.roiChange).toFixed(2) }}%
          </div>
        </div>
      </el-card>
      
      <el-card shadow="hover" class="stat-card">
        <div class="stat-content">
          <div class="stat-title">活跃计划</div>
          <div class="stat-value">{{ stats.activePlans }}</div>
          <div class="stat-change" :class="{ 'increase': stats.planChange > 0, 'decrease': stats.planChange < 0 }">
            <el-icon v-if="stats.planChange > 0"><arrow-up /></el-icon>
            <el-icon v-else-if="stats.planChange < 0"><arrow-down /></el-icon>
            {{ Math.abs(stats.planChange).toFixed(2) }}%
          </div>
        </div>
      </el-card>
    </div>
    
    <div class="charts-container">
      <el-card shadow="hover" class="chart-card">
        <template #header>
          <div class="card-header">
            <span>消耗趋势</span>
            <el-select v-model="timeRange" class="time-select" placeholder="选择时间范围">
              <el-option label="近7天" value="7d"></el-option>
              <el-option label="近30天" value="30d"></el-option>
              <el-option label="近90天" value="90d"></el-option>
            </el-select>
          </div>
        </template>
        <div id="costTrendChart" class="chart"></div>
      </el-card>
      
      <el-card shadow="hover" class="chart-card">
        <template #header>
          <div class="card-header">
            <span>平台效果对比</span>
          </div>
        </template>
        <div id="platformComparisonChart" class="chart"></div>
      </el-card>
    </div>
    
    <div class="recent-activity">
      <el-card shadow="hover">
        <template #header>
          <div class="card-header">
            <span>最近活动</span>
          </div>
        </template>
        <el-table :data="recentActivity" border style="width: 100%">
          <el-table-column prop="time" label="时间" width="180"></el-table-column>
          <el-table-column prop="activity" label="活动"></el-table-column>
          <el-table-column prop="status" label="状态" width="120">
            <template #default="scope">
              <el-tag :type="scope.row.status === 'success' ? 'success' : 'warning'">
                {{ scope.row.status === 'success' ? '成功' : '失败' }}
              </el-tag>
            </template>
          </el-table-column>
        </el-table>
      </el-card>
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted, watch } from 'vue';
import { ElMessage } from 'element-plus';
import * as echarts from 'echarts';
import { statisticsApi } from '../api';

const stats = ref({
  todayCost: 0,
  costChange: 0,
  todayConversions: 0,
  conversionChange: 0,
  todayROI: 0,
  roiChange: 0,
  activePlans: 0,
  planChange: 0,
});

const timeRange = ref('7d');
const recentActivity = ref([]);

// 图表实例
let costTrendChart = null;
let platformComparisonChart = null;

// 获取统计数据
const getStatistics = async () => {
  try {
    const response = await statisticsApi.getStatistics({ timeRange: timeRange.value });
    stats.value = response.data.summary;
    recentActivity.value = response.data.recentActivity;
    
    // 更新图表
    updateCostTrendChart(response.data.costTrend);
    updatePlatformComparisonChart(response.data.platformComparison);
  } catch (error) {
    ElMessage.error(error.message || '获取统计数据失败');
  }
};

// 初始化消耗趋势图表
const initCostTrendChart = () => {
  const chartDom = document.getElementById('costTrendChart');
  costTrendChart = echarts.init(chartDom);
  
  window.addEventListener('resize', () => {
    costTrendChart.resize();
  });
};

// 更新消耗趋势图表
const updateCostTrendChart = (data) => {
  if (!costTrendChart) return;
  
  const option = {
    tooltip: {
      trigger: 'axis',
    },
    legend: {
      data: ['消耗', '转化'],
    },
    xAxis: {
      type: 'category',
      data: data.dates,
    },
    yAxis: [
      {
        type: 'value',
        name: '消耗(元)',
        position: 'left',
      },
      {
        type: 'value',
        name: '转化',
        position: 'right',
      },
    ],
    series: [
      {
        name: '消耗',
        type: 'bar',
        data: data.costs,
        yAxisIndex: 0,
      },
      {
        name: '转化',
        type: 'line',
        data: data.conversions,
        yAxisIndex: 1,
        itemStyle: {
          color: '#52c41a',
        },
      },
    ],
  };
  
  costTrendChart.setOption(option);
};

// 初始化平台对比图表
const initPlatformComparisonChart = () => {
  const chartDom = document.getElementById('platformComparisonChart');
  platformComparisonChart = echarts.init(chartDom);
  
  window.addEventListener('resize', () => {
    platformComparisonChart.resize();
  });
};

// 更新平台对比图表
const updatePlatformComparisonChart = (data) => {
  if (!platformComparisonChart) return;
  
  const option = {
    tooltip: {
      trigger: 'axis',
      axisPointer: {
        type: 'shadow',
      },
    },
    legend: {
      data: ['消耗', '转化', 'ROI'],
    },
    xAxis: {
      type: 'category',
      data: data.platforms,
    },
    yAxis: [
      {
        type: 'value',
        name: '消耗(元)',
        position: 'left',
      },
      {
        type: 'value',
        name: '转化',
        position: 'right',
        offset: 0,
      },
      {
        type: 'value',
        name: 'ROI',
        position: 'right',
        offset: 60,
      },
    ],
    series: [
      {
        name: '消耗',
        type: 'bar',
        data: data.costs,
        yAxisIndex: 0,
      },
      {
        name: '转化',
        type: 'bar',
        data: data.conversions,
        yAxisIndex: 1,
        itemStyle: {
          color: '#52c41a',
        },
      },
      {
        name: 'ROI',
        type: 'line',
        data: data.rois,
        yAxisIndex: 2,
        itemStyle: {
          color: '#722ed1',
        },
      },
    ],
  };
  
  platformComparisonChart.setOption(option);
};

// 监听时间范围变化
watch(timeRange, (newValue) => {
  getStatistics();
});

onMounted(() => {
  initCostTrendChart();
  initPlatformComparisonChart();
  getStatistics();
});
</script>

<style scoped>
.dashboard-container {
  padding: 20px;
}

.stats-cards {
  display: flex;
  gap: 20px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.stat-card {
  flex: 1;
  min-width: 200px;
}

.stat-content {
  text-align: center;
}

.stat-title {
  font-size: 14px;
  color: #666;
  margin-bottom: 10px;
}

.stat-value {
  font-size: 24px;
  font-weight: bold;
  margin-bottom: 10px;
}

.stat-change {
  font-size: 12px;
}

.increase {
  color: #f5222d;
}

.decrease {
  color: #52c41a;
}

.charts-container {
  display: flex;
  gap: 20px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.chart-card {
  flex: 1;
  min-width: 300px;
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.time-select {
  width: 120px;
}

.chart {
  height: 300px;
}

.recent-activity {
  margin-top: 20px;
}
</style>
```
