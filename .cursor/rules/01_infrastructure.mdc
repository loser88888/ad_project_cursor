---
description: Infrastructure setup, configuration, and common components for both backend and frontend.
globs: config/**, src/store/**, src/router/**, src/api/**, src/utils/**, src/components/**
---
# 模块 1: 基础设施搭建

## ⚠️ 重要提示

**本模块是项目的基础，请确保：**
1. 严格按照 `ARCHITECTURE.md` 中的接口规范实现
2. 前后端接口必须对齐（路径、方法、参数、返回值）
3. UI 样式参考 https://www.smallfighter.cn/cidProduct.html
4. 所有响应格式统一为：`{ code, message, data }`

## 一、模块概述

本模块包含前后端项目的初始化、配置以及基础架构代码。完成后应具备：
- ✅ 前后端项目可正常启动
- ✅ 基础路由和 API 调用正常
- ✅ 统一的响应格式处理
- ✅ Token 认证机制
- ✅ 公共组件和工具函数

## 二、接口规范要求

### 2.1 统一响应格式

**所有后端接口必须返回统一格式**（参考 `ARCHITECTURE.md`）：

```javascript
// 成功响应
ctx.body = {
  code: 200,
  message: '操作成功',
  data: {
    // 具体数据
  }
};

// 错误响应
ctx.body = {
  code: 400,  // 或 401, 403, 404, 500
  message: '错误描述信息',
  data: null
};
```

### 2.2 前端 API 调用规范

**所有前端 API 调用必须：**
- 使用统一的 `api` 实例（已配置拦截器）
- 参数名与后端接口完全一致
- 处理响应时直接使用 `data` 字段（拦截器已处理）

## 三、UI 样式要求

### 3.1 设计参考

参考网站：https://www.smallfighter.cn/cidProduct.html

**样式规范**：
- **主色调**：蓝色系（#1890ff 或类似）
- **卡片样式**：圆角 8px，阴影 `0 2px 8px rgba(0,0,0,0.1)`
- **间距**：统一使用 16px、24px 的倍数
- **字体**：使用 Element Plus 默认字体

### 3.2 Element Plus 配置

```javascript
// main.js
import { createApp } from 'vue';
import ElementPlus from 'element-plus';
import 'element-plus/dist/index.css';
import * as ElementPlusIconsVue from '@element-plus/icons-vue';

const app = createApp(App);

// 注册所有图标
for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
  app.component(key, component);
}

app.use(ElementPlus);
```

## 四、后端实现（Egg.js）

### 4.1 项目初始化

```bash
# 创建Egg.js项目
mkdir ad-buying-plane-backend
cd ad-buying-plane-backend
npm init egg --type=ts
npm install

# 安装依赖
npm install egg-mongoose egg-jwt egg-cors egg-validate bcryptjs
```

### 4.2 配置文件

#### 4.2.1 数据库配置（config/plugin.js）

```javascript
module.exports = {
  mongoose: {
    enable: true,
    package: 'egg-mongoose',
  },
  jwt: {
    enable: true,
    package: 'egg-jwt',
  },
  cors: {
    enable: true,
    package: 'egg-cors',
  },
  validate: {
    enable: true,
    package: 'egg-validate',
  },
};
```

#### 4.2.2 数据库连接配置（config/config.default.js）

```javascript
module.exports = appInfo => {
  const config = {};

  // 数据库配置
  config.mongoose = {
    url: process.env.MONGODB_URI || 'mongodb://localhost:27017/ad_buying_plane',
    options: {
      useNewUrlParser: true,
      useUnifiedTopology: true,
    },
  };

  // JWT配置
  config.jwt = {
    secret: process.env.JWT_SECRET || 'your-secret-key-change-in-production',
    expiresIn: '7d',
  };

  // CORS配置
  config.cors = {
    origin: process.env.CORS_ORIGIN || '*',
    allowMethods: 'GET,HEAD,PUT,POST,DELETE,PATCH',
    credentials: true,
  };

  // 安全配置
  config.security = {
    csrf: {
      enable: false,
    },
  };

  return config;
};
```

### 4.3 统一响应中间件（app/middleware/response.js）

```javascript
module.exports = () => {
  return async function responseHandler(ctx, next) {
    try {
      await next();
      
      // 如果响应已经设置，直接返回
      if (ctx.body !== undefined) {
        // 如果已经是统一格式，直接返回
        if (ctx.body.code !== undefined) {
          return;
        }
        
        // 转换为统一格式
        ctx.body = {
          code: ctx.status === 200 ? 200 : ctx.status,
          message: ctx.body.message || '操作成功',
          data: ctx.body,
        };
      }
    } catch (err) {
      ctx.status = err.status || 500;
      ctx.body = {
        code: err.status || 500,
        message: err.message || '服务器内部错误',
        data: null,
      };
      ctx.app.emit('error', err, ctx);
    }
  };
};
```

**注册中间件**（config/config.default.js）：
```javascript
config.middleware = ['response'];
```

### 4.4 JWT 中间件配置（app/middleware/jwt.js）

```javascript
module.exports = () => {
  return async function jwtAuth(ctx, next) {
    const token = ctx.request.header.authorization;
    
    if (!token) {
      ctx.status = 401;
      ctx.body = {
        code: 401,
        message: '未提供认证令牌',
        data: null,
      };
      return;
    }

    try {
      const decoded = ctx.app.jwt.verify(
        token.replace('Bearer ', ''),
        ctx.app.config.jwt.secret
      );
      ctx.state.user = decoded;
      await next();
    } catch (err) {
      ctx.status = 401;
      ctx.body = {
        code: 401,
        message: '认证令牌无效或已过期',
        data: null,
      };
    }
  };
};
```

### 4.5 路由配置结构（app/router.js）

```javascript
module.exports = app => {
  const { router, controller, middleware } = app;
  const jwt = middleware.jwt();

  // 公开路由（无需认证）
  router.post('/api/user/register', controller.user.register);
  router.post('/api/user/login', controller.user.login);

  // 需要认证的路由
  router.get('/api/user/info', jwt, controller.user.getUserInfo);

  // 其他路由将在后续模块中补充
};
```

## 五、前端实现（Vue.js）

### 5.1 项目初始化

```bash
# 创建Vue.js项目（使用 Vue CLI）
vue create ad-buying-plane-frontend
cd ad-buying-plane-frontend

# 选择配置：Vue 3, Router, Vuex, CSS Pre-processors (Sass/SCSS)

# 安装依赖
npm install vue-router@4 pinia element-plus @element-plus/icons-vue axios echarts
npm install sass --save-dev
```

### 5.2 项目结构

```
ad-buying-plane-frontend/
├── public/
├── src/
│   ├── api/           # API请求（按模块分类）
│   │   ├── index.js   # 基础API配置
│   │   └── user.js    # 用户相关API
│   ├── assets/        # 静态资源
│   │   ├── styles/    # 全局样式
│   │   └── images/    # 图片资源
│   ├── components/    # 公共组件
│   │   ├── Pagination.vue
│   │   └── Layout.vue
│   ├── router/        # 路由配置
│   │   └── index.js
│   ├── store/         # 状态管理（Pinia）
│   │   └── index.js
│   ├── utils/         # 工具函数
│   │   ├── request.js
│   │   └── validate.js
│   ├── views/         # 页面组件
│   │   ├── Login.vue
│   │   ├── Register.vue
│   │   ├── Layout.vue
│   │   └── Dashboard.vue
│   ├── App.vue        # 根组件
│   └── main.js        # 入口文件
└── package.json
```

### 5.3 全局样式配置（src/assets/styles/main.scss）

```scss
// 主色调（参考网站）
$primary-color: #1890ff;
$success-color: #52c41a;
$warning-color: #faad14;
$error-color: #f5222d;

// 卡片样式
.card-shadow {
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  border-radius: 8px;
}

// 间距工具类
.mt-16 { margin-top: 16px; }
.mt-24 { margin-top: 24px; }
.mb-16 { margin-bottom: 16px; }
.mb-24 { margin-bottom: 24px; }
.p-16 { padding: 16px; }
.p-24 { padding: 24px; }
```

### 5.4 入口文件配置（src/main.js）

```javascript
import { createApp } from 'vue';
import App from './App.vue';
import router from './router';
import { createPinia } from 'pinia';
import ElementPlus from 'element-plus';
import 'element-plus/dist/index.css';
import * as ElementPlusIconsVue from '@element-plus/icons-vue';
import './assets/styles/main.scss';

const app = createApp(App);
const pinia = createPinia();

// 注册所有图标
for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
  app.component(key, component);
}

app.use(pinia);
app.use(router);
app.use(ElementPlus);

app.mount('#app');
```

### 5.5 路由配置（src/router/index.js）

```javascript
import { createRouter, createWebHistory } from 'vue-router';
import { useUserStore } from '../store';

const routes = [
  {
    path: '/login',
    name: 'Login',
    component: () => import('../views/Login.vue'),
    meta: { requiresAuth: false },
  },
  {
    path: '/register',
    name: 'Register',
    component: () => import('../views/Register.vue'),
    meta: { requiresAuth: false },
  },
  {
    path: '/',
    name: 'Layout',
    component: () => import('../views/Layout.vue'),
    meta: { requiresAuth: true },
    children: [
      {
        path: '/dashboard',
        name: 'Dashboard',
        component: () => import('../views/Dashboard.vue'),
      },
      // 其他路由将在后续模块添加
    ],
  },
];

const router = createRouter({
  history: createWebHistory(process.env.BASE_URL),
  routes,
});

// 路由守卫
router.beforeEach((to, from, next) => {
  const userStore = useUserStore();
  const isAuthenticated = !!userStore.token;
  
  if (to.meta.requiresAuth && !isAuthenticated) {
    next('/login');
  } else if ((to.name === 'Login' || to.name === 'Register') && isAuthenticated) {
    next('/dashboard');
  } else {
    next();
  }
});

export default router;
```

### 5.6 状态管理（Pinia）（src/store/index.js）

```javascript
import { defineStore } from 'pinia';
import { ref } from 'vue';
import { userApi } from '../api/user';

export const useUserStore = defineStore('user', () => {
  const user = ref(null);
  const token = ref(localStorage.getItem('token') || null);

  const isAuthenticated = () => !!token.value;

  const setToken = (newToken) => {
    token.value = newToken;
    if (newToken) {
      localStorage.setItem('token', newToken);
    } else {
      localStorage.removeItem('token');
    }
  };

  const setUser = (userData) => {
    user.value = userData;
  };

  const login = async (credentials) => {
    const response = await userApi.login(credentials);
    setToken(response.data.token);
    setUser(response.data.user);
    return response;
  };

  const logout = () => {
    setToken(null);
    setUser(null);
  };

  const getUserInfo = async () => {
    const response = await userApi.getUserInfo();
    setUser(response.data);
    return response;
  };

  return {
    user,
    token,
    isAuthenticated,
    setToken,
    setUser,
    login,
    logout,
    getUserInfo,
  };
});
```

### 5.7 API 请求封装（src/api/index.js）

```javascript
import axios from 'axios';
import { ElMessage } from 'element-plus';
import { useUserStore } from '../store';
import router from '../router';

// 创建Axios实例
const api = axios.create({
  baseURL: process.env.VUE_APP_API_BASE_URL || 'http://localhost:7001',
  timeout: 10000,
  headers: {
    'Content-Type': 'application/json',
  },
});

// 请求拦截器
api.interceptors.request.use(
  config => {
    const userStore = useUserStore();
    const token = userStore.token;
    if (token) {
      config.headers['Authorization'] = `Bearer ${token}`;
    }
    return config;
  },
  error => {
    return Promise.reject(error);
  }
);

// 响应拦截器
api.interceptors.response.use(
  response => {
    // 后端返回的统一格式：{ code, message, data }
    // 直接返回 data 字段，方便前端使用
    return response.data;
  },
  error => {
    // 处理错误响应
    if (error.response) {
      const { status, data } = error.response;
      
      // 401 未授权，清除token并跳转登录
      if (status === 401) {
        const userStore = useUserStore();
        userStore.logout();
        ElMessage.error('登录已过期，请重新登录');
        router.push('/login');
        return Promise.reject(data);
      }
      
      // 其他错误，显示错误信息
      const message = data?.message || '请求失败';
      ElMessage.error(message);
      return Promise.reject(data || { code: status, message, data: null });
    }
    
    // 网络错误
    ElMessage.error('网络错误，请检查网络连接');
    return Promise.reject({ code: 0, message: '网络错误', data: null });
  }
);

export default api;
```

### 5.8 用户 API（src/api/user.js）

```javascript
import api from './index';

export const userApi = {
  // 用户注册
  register: (data) => {
    return api.post('/api/user/register', {
      username: data.username,
      email: data.email,
      phone: data.phone,
      password: data.password,
    });
  },
  
  // 用户登录
  login: (data) => {
    return api.post('/api/user/login', {
      email: data.email,
      phone: data.phone,
      password: data.password,
    });
  },
  
  // 获取用户信息
  getUserInfo: () => {
    return api.get('/api/user/info');
  },
};
```

### 5.9 公共组件实现

#### 5.9.1 分页组件（src/components/Pagination.vue）

```vue
<template>
  <div class="pagination-container">
    <el-pagination
      v-model:current-page="currentPage"
      v-model:page-size="pageSize"
      :page-sizes="[10, 20, 50, 100]"
      :total="total"
      :disabled="total === 0"
      background
      layout="total, sizes, prev, pager, next, jumper"
      @size-change="handleSizeChange"
      @current-change="handleCurrentChange" 
    />
  </div>
</template>

<script setup>
import { defineProps, defineEmits, computed } from 'vue';

const props = defineProps({
  currentPage: {
    type: Number,
    default: 1,
  },
  pageSize: {
    type: Number,
    default: 10,
  },
  total: {
    type: Number,
    default: 0,
  },
});

const emit = defineEmits(['update:currentPage', 'update:pageSize', 'pageChange']);

const currentPage = computed({
  get: () => props.currentPage,
  set: (val) => emit('update:currentPage', val),
});

const pageSize = computed({
  get: () => props.pageSize,
  set: (val) => emit('update:pageSize', val),
});

const handleSizeChange = (val) => {
  emit('update:pageSize', val);
  emit('pageChange', props.currentPage, val);
};

const handleCurrentChange = (val) => {
  emit('update:currentPage', val);
  emit('pageChange', val, props.pageSize);
};
</script>

<style scoped lang="scss">
.pagination-container {
  text-align: right;
  margin-top: 24px;
  padding: 16px 0;
}
</style>
```

## 六、对齐检查清单

完成本模块后，请检查以下事项：

### 后端检查项
- [ ] 所有接口返回统一格式：`{ code, message, data }`
- [ ] JWT 中间件正确配置，Token 验证正常
- [ ] 错误处理统一，返回正确的错误码和消息
- [ ] CORS 配置正确，允许前端跨域请求

### 前端检查项
- [ ] API 拦截器正确配置，自动添加 Token
- [ ] 响应拦截器正确处理统一格式，返回 `data` 字段
- [ ] 401 错误自动跳转登录页
- [ ] 错误消息正确显示给用户

### 接口对齐检查
- [ ] 后端接口路径与前端 API 路径一致
- [ ] 请求方法（GET/POST/PUT/DELETE）正确
- [ ] 请求参数名称与后端一致
- [ ] 响应数据结构与前端期望一致

### UI 样式检查
- [ ] 主色调使用蓝色系
- [ ] 卡片样式使用圆角和阴影
- [ ] Element Plus 组件正确引入和使用
- [ ] 响应式布局正常

## 七、测试验证

### 7.1 后端测试

```bash
# 启动后端服务
npm run dev

# 测试接口（使用 Postman 或 curl）
# 注册接口
curl -X POST http://localhost:7001/api/user/register \
  -H "Content-Type: application/json" \
  -d '{"username":"test","email":"test@example.com","phone":"13800138000","password":"123456"}'

# 登录接口
curl -X POST http://localhost:7001/api/user/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"123456"}'
```

### 7.2 前端测试

```bash
# 启动前端服务
npm run serve

# 访问 http://localhost:8080
# 测试登录、注册功能
# 检查 Token 是否正确存储和使用
```

## 八、常见问题

### Q1: 前后端接口不对齐怎么办？

**A**: 
1. 检查 `ARCHITECTURE.md` 中的接口规范
2. 确保后端返回格式为 `{ code, message, data }`
3. 确保前端 API 调用参数名与后端一致
4. 使用 Postman 测试后端接口，确认返回格式

### Q2: Token 认证失败？

**A**:
1. 检查 Token 是否正确存储在 localStorage
2. 检查请求拦截器是否正确添加 Authorization 头
3. 检查后端 JWT 中间件配置
4. 检查 Token 是否过期（默认7天）

### Q3: UI 样式不符合参考网站？

**A**:
1. 检查主色调是否使用蓝色系
2. 检查卡片样式是否使用圆角和阴影
3. 参考 Element Plus 官方文档调整组件样式
4. 使用浏览器开发者工具对比参考网站样式
