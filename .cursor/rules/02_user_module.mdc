---
description: User management module including registration, login, profile management, and system settings.
globs: **/user.js, **/Login.vue, **/Register.vue, **/Settings.vue, **/user_module.md
---
# 模块 2: 用户管理模块

本模块负责用户注册、登录、信息管理及权限控制。

## 二、功能需求

### 2.2.1 用户管理模块
- 用户注册 / 登录：支持手机号、邮箱登录
- 权限管理：管理员、普通用户、访客权限控制
- 个人信息管理：基本信息修改、密码修改

### 2.2.7 系统设置
- 个人信息设置：头像、昵称、联系方式修改
- 通知设置：邮件、短信通知开关设置
- 安全设置：登录密码修改、二次验证设置

## 三、数据库设计

### 3.1.1 用户表（users）

```javascript
{
  _id: ObjectId,
  username: String,          // 用户名
  email: String,             // 邮箱
  phone: String,             // 手机号
  password: String,          // 密码（加密存储）
  avatar: String,            // 头像URL
  role: String,              // 角色：admin、user、guest
  status: String,            // 状态：active、inactive
  createdAt: Date,           // 创建时间
  updatedAt: Date            // 更新时间
}
```

索引设计：
```javascript
db.users.createIndex({ email: 1 }, { unique: true });
db.users.createIndex({ phone: 1 }, { unique: true });
```

## 四、后端实现

### 4.3.1 用户模型（app/model/user.js）

```javascript
module.exports = app => {
  const mongoose = app.mongoose;
  const Schema = mongoose.Schema;

  const UserSchema = new Schema({
    username: { type: String, required: true },
    email: { type: String, required: true, unique: true },
    phone: { type: String, required: true, unique: true },
    password: { type: String, required: true },
    avatar: { type: String },
    role: { type: String, enum: ['admin', 'user', 'guest'], default: 'user' },
    status: { type: String, enum: ['active', 'inactive'], default: 'active' },
    createdAt: { type: Date, default: Date.now },
    updatedAt: { type: Date, default: Date.now },
  });

  return mongoose.model('User', UserSchema);
};
```

### 4.4.1 用户控制器（app/controller/user.js）

```javascript
const Controller = require('egg').Controller;
const bcrypt = require('bcryptjs');

class UserController extends Controller {
  // 用户注册
  async register() {
    const { ctx } = this;
    const { username, email, phone, password } = ctx.request.body;

    // 验证参数
    ctx.validate({
      username: { type: 'string', required: true },
      email: { type: 'email', required: true },
      phone: { type: 'string', required: true },
      password: { type: 'string', required: true, min: 6 },
    });

    // 检查用户是否已存在
    const existingUser = await ctx.model.User.findOne({
      $or: [{ email }, { phone }],
    });
    if (existingUser) {
      ctx.status = 400;
      ctx.body = { message: '用户已存在' };
      return;
    }

    // 加密密码
    const hashedPassword = await bcrypt.hash(password, 10);

    // 创建用户
    const user = new ctx.model.User({
      username,
      email,
      phone,
      password: hashedPassword,
    });
    await user.save();

    ctx.status = 201;
    ctx.body = { message: '用户注册成功' };
  }

  // 用户登录
  async login() {
    const { ctx } = this;
    const { email, phone, password } = ctx.request.body;

    // 验证参数
    ctx.validate({
      email: { type: 'email', required: false },
      phone: { type: 'string', required: false },
      password: { type: 'string', required: true },
    });

    // 查找用户
    const user = await ctx.model.User.findOne({
      $or: [{ email }, { phone }],
    });
    if (!user) {
      ctx.status = 401;
      ctx.body = { message: '用户不存在' };
      return;
    }

    // 验证密码
    const isPasswordValid = await bcrypt.compare(password, user.password);
    if (!isPasswordValid) {
      ctx.status = 401;
      ctx.body = { message: '密码错误' };
      return;
    }

    // 生成JWT令牌
    const token = ctx.app.jwt.sign(
      { id: user._id, role: user.role },
      ctx.app.config.jwt.secret,
      { expiresIn: ctx.app.config.jwt.expiresIn }
    );

    ctx.body = {
      message: '登录成功',
      data: {
        token,
        user: {
          id: user._id,
          username: user.username,
          email: user.email,
          phone: user.phone,
          role: user.role,
        },
      },
    };
  }

  // 获取用户信息
  async getUserInfo() {
    const { ctx } = this;
    const userId = ctx.state.user.id;

    const user = await ctx.model.User.findById(userId).select('-password');
    if (!user) {
      ctx.status = 404;
      ctx.body = { message: '用户不存在' };
      return;
    }

    ctx.body = {
      message: '获取用户信息成功',
      data: user,
    };
  }
}

module.exports = UserController;
```

后端路由补充：
```javascript
  // 用户相关路由
  router.post('/api/user/register', controller.user.register);
  router.post('/api/user/login', controller.user.login);
  router.get('/api/user/info', jwt, controller.user.getUserInfo);
```

## 五、前端实现

### 5.5 API 补充 (src/api/index.js)

```javascript
// 用户相关API
export const userApi = {
  register: data => api.post('/api/user/register', data),
  login: data => api.post('/api/user/login', data),
  getUserInfo: () => api.get('/api/user/info'),
};
```

### 5.6.1 登录页面（src/views/Login.vue）

```vue
<template>
  <div class="login-container">
    <el-card class="login-card" shadow="hover">
      <template #header>
        <div class="card-header">
          <span>买量小飞机 - 登录</span>
        </div>
      </template>
      
      <el-form :model="form" :rules="rules" ref="formRef" label-width="80px">
        <el-form-item label="邮箱/手机号" prop="account">
          <el-input 
            v-model="form.account" 
            placeholder="请输入邮箱或手机号"
            prefix-icon="User"
          ></el-input>
        </el-form-item>
        
        <el-form-item label="密码" prop="password">
          <el-input 
            v-model="form.password" 
            type="password" 
            placeholder="请输入密码"
            prefix-icon="Lock"
            show-password
          ></el-input>
        </el-form-item>
        
        <el-form-item>
          <el-button type="primary" @click="onLogin" :loading="loading">登录</el-button>
          <el-button @click="$router.push('/register')">注册</el-button>
        </el-form-item>
      </el-form>
    </el-card>
  </div>
</template>

<script setup>
import { ref, reactive } from 'vue';
import { useRouter } from 'vue-router';
import { useStore } from 'vuex';
import { ElMessage } from 'element-plus';
import { userApi } from '../api';

const router = useRouter();
const store = useStore();
const loading = ref(false);
const formRef = ref();

const form = reactive({
  account: '',
  password: '',
});

const rules = reactive({
  account: [
    { required: true, message: '请输入邮箱或手机号', trigger: 'blur' },
  ],
  password: [
    { required: true, message: '请输入密码', trigger: 'blur' },
    { min: 6, message: '密码长度不能少于6位', trigger: 'blur' },
  ],
});

const onLogin = async () => {
  if (!formRef.value) return;
  
  await formRef.value.validate(async (valid) => {
    if (valid) {
      loading.value = true;
      
      try {
        // 判断是邮箱还是手机号
        const credentials = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(form.account)
          ? { email: form.account, password: form.password }
          : { phone: form.account, password: form.password };
        
        const response = await userApi.login(credentials);
        ElMessage.success(response.message);
        
        // 获取用户信息
        await store.dispatch('getUserInfo');
        
        // 跳转到首页
        router.push('/dashboard');
      } catch (error) {
        ElMessage.error(error.message || '登录失败');
      } finally {
        loading.value = false;
      }
    }
  });
};
</script>

<style scoped>
.login-container {
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  background-color: #f5f7fa;
}

.login-card {
  width: 400px;
}

.card-header {
  text-align: center;
  font-size: 18px;
  font-weight: bold;
}
</style>
```
