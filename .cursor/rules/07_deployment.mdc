---
description: Deployment guide for backend and frontend.
globs: deploy/**, Dockerfile, nginx.conf
---
# 模块 7: 部署与上线

## ⚠️ 重要提示

**部署前请确保：**
1. 所有模块的前后端接口已对齐验证
2. UI样式已对齐参考网站
3. 生产环境配置正确
4. 数据库备份策略已制定

## 一、部署前检查清单

### 1.1 代码检查
- [ ] 所有接口返回统一格式：`{ code, message, data }`
- [ ] 前后端接口路径一致
- [ ] 前端API调用参数与后端一致
- [ ] 错误处理完善
- [ ] 代码注释清晰

### 1.2 功能检查
- [ ] 用户登录注册功能正常
- [ ] 广告账户管理功能正常
- [ ] 广告计划管理功能正常
- [ ] 广告创意上传功能正常
- [ ] 数据统计功能正常

### 1.3 UI样式检查
- [ ] UI样式对齐参考网站（https://www.smallfighter.cn/cidProduct.html）
- [ ] 主色调使用蓝色系
- [ ] 卡片样式使用圆角和阴影
- [ ] 响应式布局正常

### 1.4 安全检查
- [ ] 密码加密存储（bcrypt）
- [ ] Token过期时间设置合理
- [ ] CORS配置正确
- [ ] 敏感信息不返回（如密码、Token）
- [ ] 文件上传大小和类型限制

### 1.5 性能检查
- [ ] 数据库索引已创建
- [ ] 接口响应时间合理
- [ ] 前端资源压缩（生产构建）

## 二、环境准备

### 2.1 服务器要求
- **操作系统**：Ubuntu 20.04+ / CentOS 7+
- **Node.js**：v16.x+
- **MongoDB**：5.0+
- **Nginx**：1.18+

### 2.2 后端环境准备

```bash
# 安装Node.js
curl -fsSL https://deb.nodesource.com/setup_16.x | sudo -E bash -
sudo apt-get install -y nodejs

# 安装MongoDB
wget -qO - https://www.mongodb.org/static/pgp/server-5.0.asc | sudo apt-key add -
echo "deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu focal/mongodb-org/5.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-5.0.list
sudo apt-get update
sudo apt-get install -y mongodb-org

# 启动MongoDB
sudo systemctl start mongod
sudo systemctl enable mongod

# 安装PM2
sudo npm install -g pm2
```

### 2.3 前端环境准备

```bash
# Node.js已安装，无需重复安装
# 安装构建工具（在开发机执行）
npm install -g @vue/cli
```

## 三、后端部署

### 3.1 项目部署

```bash
# 克隆项目
git clone https://github.com/your-username/ad-buying-plane-backend.git
cd ad-buying-plane-backend

# 安装依赖
npm install --production

# 配置环境变量（创建 .env 文件）
cat > .env << EOF
NODE_ENV=production
EGG_SERVER_ENV=prod
MONGODB_URI=mongodb://localhost:27017/ad_buying_plane
JWT_SECRET=your-production-secret-key-change-this
CORS_ORIGIN=https://your-domain.com
CRYPTO_SECRET=your-crypto-secret-key-for-token-encryption
EOF

# 使用PM2启动项目
pm2 start app.js --name ad-buying-plane-backend --env production
pm2 startup
pm2 save

# 查看日志
pm2 logs ad-buying-plane-backend
```

### 3.2 PM2配置（ecosystem.config.js）

```javascript
module.exports = {
  apps: [{
    name: 'ad-buying-plane-backend',
    script: './app.js',
    instances: 2,
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'production',
      EGG_SERVER_ENV: 'prod',
    },
    error_file: './logs/err.log',
    out_file: './logs/out.log',
    log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
    merge_logs: true,
    max_memory_restart: '1G',
  }],
};
```

## 四、前端部署

### 4.1 项目构建

```bash
# 克隆项目
git clone https://github.com/your-username/ad-buying-plane-frontend.git
cd ad-buying-plane-frontend

# 安装依赖
npm install

# 配置环境变量（创建 .env.production 文件）
cat > .env.production << EOF
VUE_APP_API_BASE_URL=https://api.your-domain.com
EOF

# 构建项目
npm run build

# 构建产物在 dist/ 目录
```

### 4.2 Nginx配置

```nginx
server {
    listen 80;
    server_name your-domain.com;

    # HTTP重定向到HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com;

    # SSL证书配置
    ssl_certificate /path/to/ssl/cert.pem;
    ssl_certificate_key /path/to/ssl/key.pem;

    # 前端静态文件
    root /path/to/ad-buying-plane-frontend/dist;
    index index.html;

    # 前端路由支持
    location / {
        try_files $uri $uri/ /index.html;
    }

    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # API代理
    location /api {
        proxy_pass http://localhost:7001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket支持（如需要）
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # 安全头
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
}
```

### 4.3 启用配置

```bash
# 创建软链接
sudo ln -s /etc/nginx/sites-available/ad-buying-plane /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重启Nginx
sudo systemctl restart nginx

# 查看状态
sudo systemctl status nginx
```

## 五、部署后验证

### 5.1 功能验证
- [ ] 前端页面可以正常访问
- [ ] 用户登录功能正常
- [ ] API接口正常响应
- [ ] 文件上传功能正常
- [ ] 数据库连接正常

### 5.2 性能验证
- [ ] 页面加载时间 < 3秒
- [ ] API响应时间 < 500ms
- [ ] 静态资源缓存生效

### 5.3 安全验证
- [ ] HTTPS证书正常
- [ ] CORS配置正确
- [ ] 敏感信息不泄露

## 六、监控和维护

### 6.1 日志监控

```bash
# PM2日志
pm2 logs ad-buying-plane-backend

# Nginx日志
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log

# MongoDB日志
sudo tail -f /var/log/mongodb/mongod.log
```

### 6.2 性能监控

- 使用PM2监控CPU和内存
- 使用Nginx监控请求统计
- 使用MongoDB监控查询性能

### 6.3 备份策略

```bash
# MongoDB备份
mongodump --uri="mongodb://localhost:27017/ad_buying_plane" --out=/backup/mongodb/$(date +%Y%m%d)

# 定期备份（添加到crontab）
0 2 * * * mongodump --uri="mongodb://localhost:27017/ad_buying_plane" --out=/backup/mongodb/$(date +\%Y\%m\%d)
```

## 七、常见问题

### Q1: PM2进程启动失败？

**A**: 
1. 检查Node.js版本是否正确
2. 检查环境变量配置
3. 查看PM2日志：`pm2 logs ad-buying-plane-backend`

### Q2: Nginx 502错误？

**A**:
1. 检查后端服务是否启动：`pm2 list`
2. 检查后端服务端口是否正确（默认7001）
3. 检查Nginx proxy_pass配置

### Q3: 前端页面空白？

**A**:
1. 检查dist目录文件是否完整
2. 检查Nginx root路径配置
3. 检查浏览器控制台错误信息

### Q4: API接口跨域错误？

**A**:
1. 检查后端CORS配置
2. 检查Nginx代理配置
3. 检查前端API baseURL配置

## 八、生产环境优化建议

1. **启用HTTPS**：使用Let's Encrypt免费SSL证书
2. **CDN加速**：静态资源使用CDN加速
3. **数据库优化**：定期执行数据库优化和维护
4. **监控告警**：配置监控告警，及时发现问题
5. **日志分析**：定期分析日志，优化性能
